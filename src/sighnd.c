/******************************************************************************/
/*                                                                            */
/*            H A N D L E   M Q   B A C K O U T   M E S S A G E S             */
/*                                                                            */
/*                         S I G N A L   H A N D L E R                        */
/*                                                                            */
/*                               S I G H N D . C                              */
/*                                                                        */
/* -------------------------------------------------------------------------- */
/*                                                                    */
/*  functions:                                                */
/*    - initSignal                                                */
/*    - bye                      */
/*    - void sig4mq                                */
/*    - sig2run                            */
/*    - setSigintFlag                                    */
/*    - checkSigint                                */
/*    - quit                        */
/*                                                      */
/******************************************************************************/

/******************************************************************************/
/*   I N C L U D E S                                                          */
/******************************************************************************/

// ---------------------------------------------------------
// system
// ---------------------------------------------------------
#include <signal.h>

// ---------------------------------------------------------
// own 
// ---------------------------------------------------------
#include <ctl.h>
#include <stdlib.h>

// ---------------------------------------------------------
// local
// ---------------------------------------------------------
#include "sighnd.h"
#include "mqbase.h"
#include <bckhnd.h>

/******************************************************************************/
/*   G L O B A L S                                                            */
/******************************************************************************/
tSigReceived _gSigIntFlag ;

/******************************************************************************/
/*   D E F I N E S                                                            */
/******************************************************************************/

/******************************************************************************/
/*   M A C R O S                                                              */
/******************************************************************************/

/******************************************************************************/
/*   P R O T O T Y P E S                                                      */
/******************************************************************************/
void setSigintFlag();
void bye();
void sig2run();
void quit();

/******************************************************************************/
/*                                                                            */
/*   F U N C T I O N S                                                        */
/*                                                                            */
/******************************************************************************/

/******************************************************************************/
/*  initialize signals                                                        */
/******************************************************************************/
void initSignal()
{
  logFuncCall( ) ;

  sig2run();
  _gSigIntFlag = NOSIG ;

  atexit(bye);

  logFuncExit( ) ;
}

/******************************************************************************/
/*  bye          */
/******************************************************************************/
void bye()
{
  logFuncCall( ) ;

  MQHCONN _hCon = getConHanlder();
  MQLONG  reason ;

  logger(LSTD_PRG_STOP, "bckhnd") ;

  reason = mqRollback(_hCon) ;
  switch( reason )
  {
    case MQRC_NONE :break;
    case MQRC_HCONN_ERROR: goto _door;
    default   : break ;
  }

  reason = mqDisc(&_hCon) ;
  switch( reason )
  {
    case MQRC_NONE :break;
    default   : break ;
  }

  _door:

  stopLogging();

}

/******************************************************************************/
/*  prepare signal handlers for MQGET                                         */
/******************************************************************************/
void sig4mq()
{
  logFuncCall( ) ;

  signal( SIGINT, setSigintFlag );

  logFuncExit( ) ;
}

/******************************************************************************/
/*  reset signal after MQGET                                                  */
/******************************************************************************/
void sig2run()
{
  logFuncCall( ) ;

  signal( SIGINT, quit );

  logFuncExit( ) ;
}

/******************************************************************************/
/*  set SIGINT  caught                                                        */
/******************************************************************************/
void setSigintFlag()
{
  logFuncCall( ) ;

  _gSigIntFlag = CAUGHT ;

  logFuncExit( ) ;
}

/******************************************************************************/
/*  check SIGINT flag                                                         */
/******************************************************************************/
void checkSigint()
{
  logFuncCall( ) ;
  if( _gSigIntFlag == CAUGHT ) exit( EXIT_SUCCESS);
  sig2run();
  logFuncExit( ) ;
}

/******************************************************************************/
/*  quit the program                                                          */
/******************************************************************************/
void quit()
{
  logFuncCall( ) ;

  exit(EXIT_SUCCESS);

  logFuncExit( ) ;
}